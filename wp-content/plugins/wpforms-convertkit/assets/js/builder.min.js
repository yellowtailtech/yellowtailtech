WPForms.Admin.Builder.Providers.ConvertKit=WPForms.Admin.Builder.Providers.ConvertKit||function(e,n,s){const a={selectors:{providersPanel:"#wpforms-panel-providers",connection:".wpforms-panel-content-section-convertkit .wpforms-builder-provider-connection",actionData:".wpforms-builder-convertkit-provider-actions-data",connections:".wpforms-panel-content-section-convertkit .wpforms-builder-provider-connection",accountField:".js-wpforms-builder-convertkit-provider-connection-account",actionField:".js-wpforms-builder-convertkit-provider-connection-action",emailField:".wpforms-builder-convertkit-provider-connection-email",formField:".wpforms-builder-convertkit-provider-connection-form",tagsField:".wpforms-builder-convertkit-provider-connection-tags",customFields:{nameFields:".js-wpforms-builder-provider-connection-field-name",closeFields:".js-wpforms-builder-convertkit-new-custom-field-close"},newAccountFormError:".wpforms-convertkit-admin-form-error",choiceJS:".choicesjs-select"},$elements:{$builder:s("#wpforms-builder"),$panel:s("#convertkit-provider"),$connections:s("#convertkit-provider .wpforms-builder-provider-connections"),$addConnectionBtn:s("#convertkit-provider .wpforms-builder-provider-title-add")},provider:"convertkit",Providers:{},Templates:{},Cache:{},isReady:!1,init(){"providers"===wpf.getQueryString("view")&&s(a.selectors.providersPanel).on("WPForms.Admin.Builder.Providers.ready",a.ready),s(e).on("wpformsPanelSwitched",function(e,n){"providers"===n&&a.ready()})},ready(){a.isReady||(a.Providers=WPForms.Admin.Builder.Providers,a.Templates=WPForms.Admin.Builder.Templates,a.Cache=a.Providers.cache,a.Templates.add(["wpforms-"+a.provider+"-builder-content-connection","wpforms-"+a.provider+"-builder-content-connection-custom-fields","wpforms-"+a.provider+"-builder-content-connection-error","wpforms-"+a.provider+"-builder-content-connection-select-field","wpforms-"+a.provider+"-builder-content-connection-text-field","wpforms-"+a.provider+"-builder-content-connection-conditionals"]),a.Providers.ui.account.registerAddHandler(a.provider,a.ui.accountForm.add),a.bindUIActions(),a.bindTriggers(),a.processInitial(),a.isReady=!0)},bindUIActions(){a.$elements.$panel.on("connectionCreate",a.connection.create).on("connectionDelete",a.connection.delete).on("change",a.selectors.accountField,a.ui.accountField.change).on("change",a.selectors.actionField,a.ui.action.change).on("change",a.selectors.customFields.nameFields,a.ui.customFields.change).on("click",a.selectors.customFields.closeFields,a.ui.customFields.close),a.$elements.$builder.on("wpformsSaved",a.connection.refresh)},bindTriggers(){a.$elements.$connections.on("connectionsDataLoaded",function(e,n){if(!_.isEmpty(n.connections))for(const o in n.connections)a.connection.generate({connection:n.connections[o],conditional:n.conditionals[o]})}),a.$elements.$connections.on("connectionGenerated",function(e,n){var o=a.connection.getById(n.connection.id);_.has(n.connection,"isNew")&&n.connection.isNew?a.connection.replaceIds(n.connection.id,o):s(a.selectors.actionField,o).trigger("change",[o])})},processInitial(){a.$elements.$connections.prepend(a.tmpl.commonsHTML()),a.connection.dataLoad()},connection:{getById(e){return a.$elements.$connections.find('.wpforms-builder-provider-connection[data-connection_id="'+e+'"]')},replaceIds(n,e){e.find("input, select, label").each(function(){var e=s(this);e.attr("name")&&e.attr("name",e.attr("name").replace(/%connection_id%/gi,n)),e.attr("id")&&e.attr("id",e.attr("id").replace(/%connection_id%/gi,n)),e.attr("for")&&e.attr("for",e.attr("for").replace(/%connection_id%/gi,n)),e.attr("data-name")&&e.attr("data-name",e.attr("data-name").replace(/%connection_id%/gi,n))})},create(e,n){var o=(new Date).getTime().toString(16),n={id:o,name:n,isNew:!0};a.Cache.addTo(a.provider,"connections",o,n),a.connection.generate({connection:n})},delete(e,n){var o=a.Providers.getProviderHolder(a.provider);n.closest(o).length&&(o=n.data("connection_id"),_.isString(o))&&a.Cache.deleteFrom(a.provider,"connections",o)},generate(e){var n=a.Cache.get(a.provider,"accounts"),o=a.Cache.get(a.provider,"actions");if(!_.isEmpty(n)&&a.account.isAccountExists(e.connection.account_id,n))return a.connection.renderConnections(n,o,e);a.ui.accountForm.dataLoad(e)},refresh(e,n){if(Object.hasOwn(n,a.provider)){const o=n[a.provider];["connections","accounts","custom_fields","forms","tags"].forEach(e=>{_.isEmpty(o[e])||a.Cache.set(a.provider,e,jQuery.extend({},o[e]))}),a.$elements.$connections.html("");for(const t in o.connections)a.connection.generate({connection:o.connections[t],conditional:o.conditionals[t]});a.connection.validate()}},validate(){_.has(n,"jconfirm")&&!_.isEmpty(n.jconfirm.instances)||s(a.selectors.connections).each(function(e,n){var n=s(n),o=n.find(a.selectors.actionField),t=n.find(a.selectors.emailField);_.isEmpty(t.val())||_.isEmpty(o.val())||"subscribe"===o.val().trim()&&(t=s(a.selectors.formField,n),o=s(a.selectors.tagsField,n),_.isEmpty(t.val()))&&_.isEmpty(o.val())&&a.modal(wpforms_builder.convertkit.subscribe_fields_error)})},renderConnections(e,n,o){var t,i;a.account.isAccountExists(o.connection.account_id,e)&&(t=a.Templates.get("wpforms-"+a.provider+"-builder-content-connection"),i=a.Templates.get("wpforms-"+a.provider+"-builder-content-connection-conditionals"),i=_.has(o.connection,"isNew")&&o.connection.isNew?i():o.conditional,a.$elements.$connections.prepend(t({accounts:e,actions:n,connection:o.connection,conditional:i,provider:a.provider})),a.$elements.$connections.trigger("connectionGenerated",[o]))},dataLoad(){a.Providers.ajax.request(a.provider,{data:{task:"connections_get"}}).done(function(n){n.success&&_.has(n.data,"connections")&&(["connections","conditionals","actions","actions_fields","accounts","custom_fields","forms","tags"].forEach(e=>{a.Cache.set(a.provider,e,jQuery.extend({},n.data[e]))}),a.$elements.$connections.trigger("connectionsDataLoaded",[n.data]))})}},account:{isAccountExists(e,n){return!_.isEmpty(n)&&(!!_.isEmpty(e)||_.has(n,e))}},ui:{accountForm:{add(n){const o=n.$$add;if(!o.prop("disabled")){o.prop("disabled","disabled");var e=a.ui.accountForm.validateFields(n);if(!1===e)o.removeAttr("disabled");else{const t=n.$content.find(a.selectors.newAccountFormError);n.setType("blue"),t.hide(),a.Providers.ajax.request(a.provider,{data:{task:"account_save",data:e}}).done(function(e){if(e.success)return a.$elements.$addConnectionBtn.toggleClass("hidden"),n.close(),!0;_.has(e,"data")&&_.has(e.data,"error_msg")&&t.html(e.data.error_msg),t.show(),o.removeAttr("disabled")})}}return!1},validateFields(e){const n=e.$content.find("input.wpforms-required"),i={};let r=!1;return n.each(function(e,n){var n=s(n),o=n.siblings(".error"),t=n.attr("name");i[t]=n.val().trim(),_.isEmpty(i[t])?(n.addClass("wpforms-error"),o.text(wpforms_builder_providers.required_field).show(),r=!0):(n.removeClass("wpforms-error"),o.hide())}),!0!==r&&i},dataLoad(e){const o=a.Cache.get(a.provider,"actions");a.Providers.ajax.request(a.provider,{data:{task:"accounts_get"}}).done(function(n){["accounts","custom_fields","forms","tags"].forEach(e=>{_.isEmpty(n.data[e])||a.Cache.set(a.provider,e,jQuery.extend({},n.data[e]))}),a.connection.renderConnections(n.data.accounts,o,e)})}},accountField:{change(){var e=s(this),n=e.closest(a.selectors.connection),o=s(a.selectors.actionField,n);s(a.selectors.actionData,n).html(""),o.prop("selectedIndex",0),_.isEmpty(e.val())?o.prop("disabled",!0):(o.prop("disabled",!1),e.removeClass("wpforms-error"))}},action:{change(){var e=s(this),n=e.closest(a.selectors.connection),o=s(a.selectors.accountField,n),t=s(a.selectors.actionField,n);e.removeClass("wpforms-error"),a.ui.action.render({action:"action",target:e,account_id:o.val(),action_name:t.val(),connection_id:n.data("connection_id")})},render(e){var n=wpf.getFields(),n=a.tmpl.renderActionFields(e,n),o=a.connection.getById(e.connection_id);s(a.selectors.actionData,o).html(n),a.$elements.$connections.trigger("connectionRendered",[a.provider,e.connection_id]),a.ui.action.initChoicesJS(o)},initChoicesJS(e){"function"==typeof n.Choices&&s(a.selectors.choiceJS,e).each(function(e,n){n=s(n);void 0===n.data("choicesjs")&&n.data("choicesjs",new Choices(n[0],{shouldSort:!1,removeItemButton:!0,fuseOptions:{threshold:.1,distance:1e3},callbackOnInit(){wpf.initMultipleSelectWithSearch(this),wpf.showMoreButtonForChoices(this.containerOuter.element)}}))})}},customFields:{change(){var e=s(this),n=e.closest("td"),o="new_custom_field"===e.val(),t=n.find('input[type="text"]'),i="wpforms-builder-convertkit-is-new-custom-field";o?(n.addClass(i),t.attr("name",e.attr("name"))):(n.removeClass(i),t.attr("name",""))},close(e){e.preventDefault();var e=s(this).closest("td"),n=e.find("select"),o=e.find('input[type="text"]');n.prop("selectedIndex",0),e.removeClass("wpforms-builder-convertkit-is-new-custom-field"),o.attr("name","").val("")}}},tmpl:{commonsHTML(){return a.Templates.get("wpforms-"+a.provider+"-builder-content-connection-error")()},renderActionFields(t,i){const r=a.Cache.get(a.provider,"actions_fields");let c="";return s.each(r[t.target.val()],function(e,n){["form","tags","custom_fields"].includes(e)&&(n.options=a.Cache.getById(a.provider,"form"===e?"forms":e,t.account_id));var o="custom-fields"===n.type?"wpforms-"+a.provider+"-builder-content-connection-"+n.type:"wpforms-"+a.provider+"-builder-content-connection-"+n.type+"-field",o=a.Templates.get(o);c+=o({connection:a.Cache.getById(a.provider,"connections",t.connection_id),name:e,field:n,provider:{slug:a.provider,fields:r[t.target.val()]},options:i})}),c}},modal(e){e&&s.alert({title:wpforms_builder.heads_up,content:e,icon:"fa fa-exclamation-circle",type:"orange",buttons:{confirm:{text:wpforms_builder.ok,btnClass:"btn-confirm",keys:["enter"]}}})}};return a}(document,window,jQuery),WPForms.Admin.Builder.Providers.ConvertKit.init();